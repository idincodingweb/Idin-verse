import { Canvas, useThree, useFrame } from '@react-three/fiber';
import { PerspectiveCamera, OrbitControls, useGLTF, Environment, ContactShadows, useAnimations } from '@react-three/drei';
import { Suspense, useEffect, useRef, useState } from 'react';
import DialogueCard from '@/components/DialogueCard';
import TransitionOverlay from '@/components/TransitionOverlay'; 
import * as THREE from 'three';
import { Vector3 } from 'three';

// --- MODEL YUMI ---
function YumiModel() {
  const group = useRef<THREE.Group>(null);
  const { scene, animations } = useGLTF('/yumi.glb', true);
  const { actions } = useAnimations(animations, group);
  useEffect(() => {
    if (actions && Object.keys(actions).length > 0) {
      const firstAnim = Object.keys(actions)[0];
      actions[firstAnim]?.reset().fadeIn(0.5).play();
    }
  }, [actions]);
  return (
    <group ref={group} position={[0, -1.7, 0]}>
      <primitive object={scene} scale={1.1} />
    </group>
  );
}

// --- KOTA KARAWANG ---
function CityModel() {
  const { scene } = useGLTF('/city.glb', true);
  return (
    <group position={[0, -2.5, 0]}>
      <primitive object={scene} scale={1} />
      <directionalLight position={[10, 20, 5]} intensity={2} color="#ffeedd" />
      <ambientLight intensity={1.5} color="#bbaaff" /> 
    </group>
  );
}

const Index = () => {
  const [mode, setMode] = useState<'YUMI' | 'CITY'>('YUMI');
  const [isTransitioning, setIsTransitioning] = useState(false);
  
  // Refs untuk audio
  const sfxCityRef = useRef<HTMLAudioElement | null>(null);  
  const bgmRef = useRef<HTMLAudioElement | null>(null);      

  const handleUnlock = () => {
    // Jalankan BGM (suara3.mp3)
    if (bgmRef.current) {
      bgmRef.current.volume = 0.4;
      bgmRef.current.play();
    }
    
    setIsTransitioning(true);

    setTimeout(() => {
      setMode('CITY');
      // Narasi Kota (suara2.mp3) muncul setelah transisi
      setTimeout(() => {
        if (sfxCityRef.current && bgmRef.current) {
          bgmRef.current.volume = 0.15; // Ducking
          sfxCityRef.current.play();
          sfxCityRef.current.onended = () => { if (bgmRef.current) bgmRef.current.volume = 0.4; };
        }
      }, 1500);
    }, 1200);

    setTimeout(() => setIsTransitioning(false), 2500);
  };

  return (
    <div className="relative w-full h-screen bg-black overflow-hidden font-sans">
      {/* ASSET AUDIO */}
      <audio ref={sfxCityRef} src="/audio/suara2.mp3" />
      <audio ref={bgmRef} src="/audio/suara3.mp3" loop />

      <div className="absolute inset-0 z-0">
        <Canvas shadows gl={{ antialias: false }}> 
            <color attach="background" args={['#050510']} />
            <PerspectiveCamera makeDefault position={[0, 0, 5]} fov={40} />
            <OrbitControls enableZoom={true} enablePan={true} maxPolarAngle={Math.PI / 2} />
            <Environment preset="city" />
            
            <Suspense fallback={null}>
                {mode === 'YUMI' ? <YumiModel /> : <CityModel />}
            </Suspense>
            
            {mode === 'YUMI' && <ContactShadows opacity={0.6} scale={10} blur={2} color="#000000" />}
        </Canvas>
      </div>

      <div className="absolute inset-0 z-40 pointer-events-none">
        <TransitionOverlay isActive={isTransitioning} />
      </div>

{/* UI LAYER - DialogueCard dengan posisi yang lebih proporsional */}
{mode === 'YUMI' && !isTransitioning && (
  <div className="absolute inset-0 z-50 flex items-end justify-center pointer-events-none pb-40"> 
     <div className="w-full pointer-events-auto flex justify-center">
        <DialogueCard onUnlock={handleUnlock} />
     </div>
  </div>
)}

      {/* HEADER KOTA */}
      {mode === 'CITY' && !isTransitioning && (
        <div className="absolute top-8 left-8 z-50 pointer-events-none select-none">
            <div className="text-white text-3xl font-black uppercase tracking-tighter">Karawang, <span className="text-cyan-400">Indonesia</span></div>
            <div className="text-purple-300 text-xs font-bold tracking-[0.2em]">BY IDIN ISKANDAR</div>
        </div>
      )}
    </div>
  );
};

export default Index;